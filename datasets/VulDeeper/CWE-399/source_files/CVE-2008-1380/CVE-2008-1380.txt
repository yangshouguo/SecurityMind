diff -U8 -p -r3.214.2.41 jsapi.c
--- mozilla/js/src/jsapi.c	29 Feb 2008 21:14:16 -0000	3.214.2.41
+++ mozilla/js/src/jsapi.c	28 Mar 2008 18:53:28 -0000
@@ -4078,20 +4078,20 @@ JS_CompileUCFunctionForPrincipals(JSCont
         funAtom = js_Atomize(cx, name, strlen(name), 0);
         if (!funAtom) {
             fun = NULL;
             goto out2;
         }
     }
     fun = js_NewFunction(cx, NULL, NULL, nargs, 0, obj, funAtom);
     if (!fun)
-        goto out;
+        goto out2;
 
     /* From this point the control must flow through the label out. */
-    JS_PUSH_TEMP_ROOT_FUNCTION(cx, fun, &tvr);
+    JS_PUSH_TEMP_ROOT_OBJECT(cx, fun->object, &tvr);
     if (nargs) {
         for (i = 0; i < nargs; i++) {
             argAtom = js_Atomize(cx, argnames[i], strlen(argnames[i]), 0);
             if (!argAtom)
                 break;
             if (!js_AddHiddenProperty(cx, fun->object, ATOM_TO_JSID(argAtom),
                                       js_GetArgument, js_SetArgument,
                                       SPROP_INVALID_SLOT,
@@ -4108,22 +4108,23 @@ JS_CompileUCFunctionForPrincipals(JSCont
     if (!js_CompileFunctionBody(cx, ts, fun)) {
         fun = NULL;
         goto out;
     }
     if (obj && funAtom) {
         if (!OBJ_DEFINE_PROPERTY(cx, obj, ATOM_TO_JSID(funAtom),
                                  OBJECT_TO_JSVAL(fun->object),
                                  NULL, NULL, JSPROP_ENUMERATE, NULL)) {
-            return NULL;
+            fun = NULL;
+            goto out;
         }
     }
+    cx->weakRoots.newborn[GCX_OBJECT] = (JSGCThing *) fun->object;
 
   out:
-    cx->weakRoots.newborn[GCX_PRIVATE] = (JSGCThing *) fun;
     JS_POP_TEMP_ROOT(cx, &tvr);
 
   out2:
     if (ts)
         js_CloseTokenStream(cx, ts);
     JS_ARENA_RELEASE(&cx->tempPool, mark);
     LAST_FRAME_CHECKS(cx, fun);
     return fun;
diff -U8 -p -r3.80.4.23 jscntxt.h
--- mozilla\js\src\jscntxt.h	15 Feb 2008 19:36:37 -0000	3.80.4.23
+++ mozilla\js\src\jscntxt.h	28 Mar 2008 18:53:28 -0000
@@ -582,19 +582,16 @@ JS_STATIC_ASSERT(sizeof(JSTempValueUnion
     JS_PUSH_TEMP_ROOT_COMMON(cx, val, tvr, JSTVU_SINGLE, value)
 
 #define JS_PUSH_TEMP_ROOT_OBJECT(cx,obj,tvr)                                  \
     JS_PUSH_TEMP_ROOT_COMMON(cx, obj, tvr, JSTVU_SINGLE, object)
 
 #define JS_PUSH_TEMP_ROOT_STRING(cx,str,tvr)                                  \
     JS_PUSH_TEMP_ROOT_COMMON(cx, str, tvr, JSTVU_SINGLE, string)
 
-#define JS_PUSH_TEMP_ROOT_FUNCTION(cx,fun,tvr)                                \
-    JS_PUSH_TEMP_ROOT_COMMON(cx, fun, tvr, JSTVU_SINGLE, function)
-
 #define JS_PUSH_TEMP_ROOT_QNAME(cx,qn,tvr)                                    \
     JS_PUSH_TEMP_ROOT_COMMON(cx, qn, tvr, JSTVU_SINGLE, qname)
 
 #define JS_PUSH_TEMP_ROOT_XML(cx,xml_,tvr)                                    \
     JS_PUSH_TEMP_ROOT_COMMON(cx, xml_, tvr, JSTVU_SINGLE, xml)
 
 #define JS_PUSH_TEMP_ROOT_MARKER(cx,marker_,tvr)                              \
     JS_PUSH_TEMP_ROOT_COMMON(cx, marker_, tvr, JSTVU_MARKER, marker)
diff -U8 -p -r3.17.20.6 jsprvtd.h
--- mozilla\js\src\jsprvtd.h	15 Feb 2008 19:36:37 -0000	3.17.20.6
+++ mozilla\js\src\jsprvtd.h	28 Mar 2008 18:53:28 -0000
@@ -207,17 +207,16 @@ typedef JSBool
  */
 typedef void
 (* JS_DLL_CALLBACK JSTempValueMarker)(JSContext *cx, JSTempValueRooter *tvr);
 
 typedef union JSTempValueUnion {
     jsval               value;
     JSObject            *object;
     JSString            *string;
-    JSFunction          *function;
     JSXML               *xml;
     JSXMLQName          *qname;
     JSTempValueMarker   marker;
     JSScopeProperty     *sprop;
     JSWeakRoots         *weakRoots;
     JSScript            *script;
     jsval               *array;
 } JSTempValueUnion;
