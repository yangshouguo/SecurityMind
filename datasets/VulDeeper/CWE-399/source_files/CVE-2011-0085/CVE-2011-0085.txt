diff --git a/content/xul/document/src/nsXULCommandDispatcher.cpp b/content/xul/document/src/nsXULCommandDispatcher.cpp
--- a/content/xul/document/src/nsXULCommandDispatcher.cpp
+++ b/content/xul/document/src/nsXULCommandDispatcher.cpp
@@ -401,43 +401,51 @@
   nsCOMPtr<nsIDOMElement> element;
   GetFocusedElement(getter_AddRefs(element));
   if (element) {
     nsresult rv = element->GetAttribute(NS_LITERAL_STRING("id"), id);
     NS_ASSERTION(NS_SUCCEEDED(rv), "unable to get element's id");
     if (NS_FAILED(rv)) return rv;
   }
 
+  nsCOMArray<nsIContent> updaters;
+
   for (Updater* updater = mUpdaters; updater != nsnull; updater = updater->mNext) {
     // Skip any nodes that don't match our 'events' or 'targets'
     // filters.
     if (! Matches(updater->mEvents, aEventName))
       continue;
 
     if (! Matches(updater->mTargets, id))
       continue;
 
     nsCOMPtr<nsIContent> content = do_QueryInterface(updater->mElement);
     NS_ASSERTION(content != nsnull, "not an nsIContent");
     if (! content)
       return NS_ERROR_UNEXPECTED;
 
+    updaters.AppendObject(content);
+  }
+
+  for (PRUint32 u = 0; u < updaters.Count(); u++) {
+    nsIContent* content = updaters[u];
+
     nsCOMPtr<nsIDocument> document = content->GetDocument();
 
     NS_ASSERTION(document != nsnull, "element has no document");
     if (! document)
       continue;
 
 #ifdef NS_DEBUG
     if (PR_LOG_TEST(gLog, PR_LOG_NOTICE)) {
       nsCAutoString aeventnameC; 
       CopyUTF16toUTF8(aEventName, aeventnameC);
       PR_LOG(gLog, PR_LOG_NOTICE,
              ("xulcmd[%p] update %p event=%s",
-              this, updater->mElement.get(),
+              this, content,
               aeventnameC.get()));
     }
 #endif
 
     nsPresShellIterator iter(document);
     nsCOMPtr<nsIPresShell> shell;
     while ((shell = iter.GetNextShell())) {
 
diff --git a/content/xul/document/test/Makefile.in b/content/xul/document/test/Makefile.in
--- a/content/xul/document/test/Makefile.in
+++ b/content/xul/document/test/Makefile.in
@@ -52,16 +52,18 @@
 		test_bug414907.xul \
 		test_bug418216.xul \
 		test_bug445177.xul \
 		test_bug449457.xul \
 		test_bug468176.xul \
 		$(NULL)
 
 _CHROME_FILES = \
+		test_bug583948.xul \
+		window_bug583948.xul \
 		test_bug497875.xul \
 		     bug497875-iframe.xul \
 		$(NULL)
 
 libs:: $(_TEST_FILES)
 	$(INSTALL) $(foreach f,$^,"$f") $(DEPTH)/_tests/testing/mochitest/tests/$(relativesrcdir)
 
 libs:: $(_CHROME_FILES)
diff --git a/content/xul/document/test/test_bug583948.xul b/content/xul/document/test/test_bug583948.xul
new file mode 100644
--- /dev/null
+++ b/content/xul/document/test/test_bug583948.xul
@@ -0,0 +1,41 @@
+<?xml version="1.0"?>
+<?xml-stylesheet href="chrome://global/skin" type="text/css"?>
+<?xml-stylesheet href="chrome://mochikit/content/tests/SimpleTest/test.css"
+                 type="text/css"?>
+
+<window xmlns="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul">
+
+<script type="application/javascript" src="chrome://mochikit/content/MochiKit/packed.js"></script>
+<script type="application/javascript" src="chrome://mochikit/content/tests/SimpleTest/SimpleTest.js" />
+
+<body xmlns="http://www.w3.org/1999/xhtml">
+  <div id="content" style="display: none"/>
+</body>
+
+<script>
+SimpleTest.waitForExplicitFinish();
+
+var attempts = 0;
+
+function update() {
+  setTimeout(function() {
+    if (otherWindow.location)
+      otherWindow.location.reload()
+    }, 1);
+  otherWindow.document.commandDispatcher.updateCommands('');
+  // without the crash fix, this usually crashes after 2 to 4 reloads
+  if (++attempts == 6) {
+    ok(true, "didn't crash after 6 attempts");
+    otherWindow.close();
+    SimpleTest.finish();
+  }
+  else {
+    setTimeout(update, 100);
+  }
+}
+
+var otherWindow = window.open("window_bug583948.xul", "_new", "chrome");
+setTimeout(update, 100);
+</script>
+
+</window>
diff --git a/content/xul/document/test/window_bug583948.xul b/content/xul/document/test/window_bug583948.xul
new file mode 100644
--- /dev/null
+++ b/content/xul/document/test/window_bug583948.xul
@@ -0,0 +1,8 @@
+<?xml-stylesheet href="chrome://browser/skin/" type="text/css"?>
+<window xmlns="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul">
+
+<command oncommandupdate="document.removeChild(document.documentElement)" commandupdater="true"/>
+<box command="c"/>
+<iframe/>
+
+</window>
