diff -p -u -6 -r1.43 nsEscape.cpp
--- a/xpcom/io/nsEscape.cpp	25 Oct 2008 05:23:36 -0000	1.43
+++ b/xpcom/io/nsEscape.cpp	14 Nov 2008 23:28:09 -0000
@@ -292,13 +292,13 @@ nsEscapeHTML2(const PRUnichar *aSourceBu
   if (aSourceBufferLen == -1) {
     aSourceBufferLen = nsCRT::strlen(aSourceBuffer); // ...then I will
   }
 
   /* XXX Hardcoded max entity len. */
   if (aSourceBufferLen >=
-      ((PR_UINT32_MAX / (6 * sizeof(PRUnichar))) + sizeof(PRUnichar)))
+      ((PR_UINT32_MAX - sizeof(PRUnichar)) / (6 * sizeof(PRUnichar))) )
     return nsnull;
 
   PRUnichar *resultBuffer = (PRUnichar *)nsMemory::Alloc(aSourceBufferLen *
                             6 * sizeof(PRUnichar) + sizeof(PRUnichar('\0')));
   PRUnichar *ptr = resultBuffer;
 
