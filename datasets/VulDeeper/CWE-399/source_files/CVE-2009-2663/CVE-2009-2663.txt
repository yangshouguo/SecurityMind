diff --git a/media/libvorbis/README_MOZILLA b/media/libvorbis/README_MOZILLA
--- a/media/libvorbis/README_MOZILLA
+++ b/media/libvorbis/README_MOZILLA
@@ -11,8 +11,10 @@ support for builds with WINCE defined.
 
 BUG 469639 - Failed to build firefox trunk on OpenSolaris
 
 bug481601.patch is appled to fix bug 481601.
 bug487519.patch: fix for bug 487519.
 bug498827.patch: fix for bug 498827
 bug498855.patch: fix for bug 498855
 bug498853.patch: fix for bug 498853
+r16181.patch: cherrypick from libvorbis svn r16181 for bug 500254.
+r16182.patch: cherrypick from libvorbis svn r16182 for bug 500254.
diff --git a/media/libvorbis/lib/vorbis_floor1.c b/media/libvorbis/lib/vorbis_floor1.c
index 0e06c6d..e06a191 100644
--- a/media/libvorbis/lib/vorbis_floor1.c
+++ b/media/libvorbis/lib/vorbis_floor1.c
@@ -133,16 +133,19 @@ static void floor1_pack (vorbis_info_floor *i,oggpack_buffer *opb){
 
   for(j=0,k=0;j<info->partitions;j++){
     count+=info->class_dim[info->partitionclass[j]]; 
     for(;k<count;k++)
       oggpack_write(opb,info->postlist[k+2],rangebits);
   }
 }
 
+static int icomp(const void *a,const void *b){
+  return(**(int **)a-**(int **)b);
+}
 
 static vorbis_info_floor *floor1_unpack (vorbis_info *vi,oggpack_buffer *opb){
   codec_setup_info     *ci=vi->codec_setup;
   int j,k,count=0,maxclass=-1,rangebits;
 
   vorbis_info_floor1 *info=_ogg_calloc(1,sizeof(*info));
   /* read partitions */
   info->partitions=oggpack_read(opb,5); /* only 0 to 31 legal */
@@ -177,27 +180,34 @@ static vorbis_info_floor *floor1_unpack (vorbis_info *vi,oggpack_buffer *opb){
       int t=info->postlist[k+2]=oggpack_read(opb,rangebits);
       if(t<0 || t>=(1<<rangebits))
 	goto err_out;
     }
   }
   info->postlist[0]=0;
   info->postlist[1]=1<<rangebits;
 
+  /* don't allow repeated values in post list as they'd result in
+     zero-length segments */
+  {
+    int *sortpointer[VIF_POSIT+2];
+    for(j=0;j<count+2;j++)sortpointer[j]=info->postlist+j;
+    qsort(sortpointer,count+2,sizeof(*sortpointer),icomp);
+
+    for(j=1;j<count+2;j++)
+      if(*sortpointer[j-1]==*sortpointer[j])goto err_out;
+  }
+
   return(info);
   
  err_out:
   floor1_free_info(info);
   return(NULL);
 }
 
-static int icomp(const void *a,const void *b){
-  return(**(int **)a-**(int **)b);
-}
-
 static vorbis_look_floor *floor1_look(vorbis_dsp_state *vd,
 				      vorbis_info_floor *in){
 
   int *sortpointer[VIF_POSIT+2];
   vorbis_info_floor1 *info=(vorbis_info_floor1 *)in;
   vorbis_look_floor1 *look=_ogg_calloc(1,sizeof(*look));
   int i,j,n=0;
 
diff --git a/media/libvorbis/lib/vorbis_res0.c b/media/libvorbis/lib/vorbis_res0.c
--- a/media/libvorbis/lib/vorbis_res0.c
+++ b/media/libvorbis/lib/vorbis_res0.c
@@ -215,18 +215,20 @@ vorbis_info_residue *res0_unpack(vorbis_info *vi,oggpack_buffer *opb){
     info->secondstages[j]=cascade;
 
     acc+=icount(cascade);
   }
   for(j=0;j<acc;j++)
     info->booklist[j]=oggpack_read(opb,8);
 
   if(info->groupbook>=ci->books)goto errout;
-  for(j=0;j<acc;j++)
+  for(j=0;j<acc;j++){
     if(info->booklist[j]>=ci->books)goto errout;
+    if(ci->book_param[info->booklist[j]]->maptype==0)goto errout;
+  }
 
   return(info);
  errout:
   res0_free_info(info);
   return(NULL);
 }
 
 vorbis_look_residue *res0_look(vorbis_dsp_state *vd,
diff --git a/media/libvorbis/r16181.patch b/media/libvorbis/r16181.patch
new file mode 100644
index 0000000..9bce63b
--- /dev/null
+++ b/media/libvorbis/r16181.patch
@@ -0,0 +1,28 @@
+Author: xiphmont <xiphmont@0101bb08-14d6-0310-b084-bc0e0c8e3800>
+Date:   Thu Jun 25 03:39:41 2009 +0000
+
+    First half of fix for Mozilla BZ #500254
+    
+    Residue code was not checking that its partition books were books with
+    specified/populated value mappings.  Fuzzer twiddled the book table suck that a valid codebook was being swapped out for a codebook with no value mapping.
+    
+    
+    
+    git-svn-id: http://svn.xiph.org/trunk/vorbis@16181 0101bb08-14d6-0310-b084-bc0e0c8e3800
+
+diff --git a/lib/vorbis_res0.c b/lib/vorbis_res0.c
+index b4a7469..48caa27 100644
+--- a/lib/vorbis_res0.c
++++ b/lib/vorbis_res0.c
+@@ -220,8 +220,10 @@ vorbis_info_residue *res0_unpack(vorbis_info *vi,oggpack_buffer *opb){
+     info->booklist[j]=oggpack_read(opb,8);
+ 
+   if(info->groupbook>=ci->books)goto errout;
+-  for(j=0;j<acc;j++)
++  for(j=0;j<acc;j++){
+     if(info->booklist[j]>=ci->books)goto errout;
++    if(ci->book_param[info->booklist[j]]->maptype==0)goto errout;
++  }
+ 
+   /* verify the phrasebook is not specifying an impossible or
+      inconsistent partitioning scheme. */
diff --git a/media/libvorbis/r16182.patch b/media/libvorbis/r16182.patch
new file mode 100644
index 0000000..d9f3a7c
--- /dev/null
+++ b/media/libvorbis/r16182.patch
@@ -0,0 +1,54 @@
+Author: xiphmont <xiphmont@0101bb08-14d6-0310-b084-bc0e0c8e3800>
+Date:   Thu Jun 25 03:53:49 2009 +0000
+
+    Second half of fix to Mozilla BZ # 5000254: sanity check the floor 1
+    post list to reject files with repeated values that would result in
+    floor line segments with zero length.
+    
+    
+    
+    git-svn-id: http://svn.xiph.org/trunk/vorbis@16182 0101bb08-14d6-0310-b084-bc0e0c8e3800
+
+diff --git a/lib/vorbis_floor1.c b/lib/vorbis_floor1.c
+index 7052304..6d47459 100644
+--- a/lib/vorbis_floor1.c
++++ b/lib/vorbis_floor1.c
+@@ -120,6 +120,9 @@ static void floor1_pack (vorbis_info_floor *i,oggpack_buffer *opb){
+   }
+ }
+ 
++static int icomp(const void *a,const void *b){
++  return(**(int **)a-**(int **)b);
++}
+ 
+ static vorbis_info_floor *floor1_unpack (vorbis_info *vi,oggpack_buffer *opb){
+   codec_setup_info     *ci=vi->codec_setup;
+@@ -164,6 +167,17 @@ static vorbis_info_floor *floor1_unpack (vorbis_info *vi,oggpack_buffer *opb){
+   info->postlist[0]=0;
+   info->postlist[1]=1<<rangebits;
+ 
++  /* don't allow repeated values in post list as they'd result in
++     zero-length segments */
++  {
++    int *sortpointer[VIF_POSIT+2];
++    for(j=0;j<count+2;j++)sortpointer[j]=info->postlist+j;
++    qsort(sortpointer,count+2,sizeof(*sortpointer),icomp);
++
++    for(j=1;j<count+2;j++)
++      if(*sortpointer[j-1]==*sortpointer[j])goto err_out;
++  }
++
+   return(info);
+ 
+  err_out:
+@@ -171,10 +185,6 @@ static vorbis_info_floor *floor1_unpack (vorbis_info *vi,oggpack_buffer *opb){
+   return(NULL);
+ }
+ 
+-static int icomp(const void *a,const void *b){
+-  return(**(int **)a-**(int **)b);
+-}
+-
+ static vorbis_look_floor *floor1_look(vorbis_dsp_state *vd,
+                                       vorbis_info_floor *in){
+ 
diff --git a/media/libvorbis/update.sh b/media/libvorbis/update.sh
index ffb55d1..9e757c5 100644
--- a/media/libvorbis/update.sh
+++ b/media/libvorbis/update.sh
@@ -47,8 +47,10 @@ cp $1/COPYING ./COPYING
 cp $1/README ./README
 cp $1/AUTHORS ./AUTHORS
 patch -p3 < ./alloca.diff
 patch -p3 <./bug481601.patch
 patch -p3 <bug487519.patch
 patch -p3 <bug498827.patch
 patch -p3 <bug498855.patch
 patch -p3 <bug498853.patch
+patch -p1 <r16181.patch
+patch -p1 <r16182.patch
